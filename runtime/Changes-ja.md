# Elona foobar

作業中です。内容は誤っている可能性があります。



## 本家のバグ修正

- Elona不具合修正Wikiにある既知のバグを修正
  - 多すぎるのでまた後で
- カジノの報酬を生成するのに失敗するとフリーズするのを修正
- 引っ越したときに雇用人が消えてしまうのを修正
- 洞窟を出ずに死ぬと洞窟から出られなくなるのを修正
- 壁やドアで埋められたマップに入ると無限ループになるのを修正
- 神の下僕のようなペットのユニークNPCと会話できないのを修正
- とある条件下でシナリオ進行中にPCが死ぬのを修正
- 混沌三神が願いの杖を落とさなかったのを修正
- Elonaのウィンドウサイズが800x600以外だったとき、レシピウィンドウのY座標がずれるのを修正
- 収穫依頼の報酬がオーバーフローするのを修正
- 幸運を維持する装備を食べると落ちるのを修正
  - これを避けるため幸運の成長バフを新たに追加
- 金貨/プラチナがオーバーフローするのを修正
- カジノでカードが配られているときの入力は保持しないように
- ウィンドウサイズが十分に大きいとき、小さいマップの左下の描写がおかしくなるのを修正
- シェルターの上でシェルターを建設するとスタックするのを修正
- 死者の洞窟のグローバルマップにおける位置を一つ右に移動。以前の位置は崖の上であり、不正な位置であった。そのためそれぞれのセーブデータで異なる位置に配置される可能性があり、また稀に地殻変動のたびに死者の洞窟が動くようになっていた
- 英語のテキストにおける省略記号をピリオド三つで置き換え。英語のフォントの中にはこの文字を持っていないものがあるため
- エーテル病の進行度が上限を超えて進むことがあるのを修正
- クミロミを信仰していると食べ物が腐らないことがあるのを修正
- 綴り鎧のアイテムチップが高すぎる場所にスタックするのを修正
- 天候が変わった際、メッセージログウィンドウに現れる空白を削除
- 選択キーの周りに表示されるゴミを削除
- ダブルベッドと幸せのベッドのグラフィックが切れていたのを修正
- 見た目の変更メニューにおける PCC のアスペクト比を修正
- 「何かが地面に落ちた」のメッセージはアイテムが地面にある場合には表示しないように
- 3つの関所マップが屋内扱いだったのを修正
- アイテムの不自然なサブカテゴリを修正
  - 苺: その他 → 果物
  - 英雄チーズ: 果物 → その他
  - うさぎのしっぽ: 果物 → その他
- 模様替えの際にカーソルを左上のタイルに動かすとちらつくのを修正
- プロポーショナルフォントを使っていてもアイテムリストメニューの耐性表示が縦に揃うように
- `{sex}`タグがPCの性別に関わらず常に「男」で置き換わっていたのを修正
- スクロール=する / 走り時スクロール=する / 走りの速さ=3 のとき、走れなくなるのを修正
- ストーリーの開始時刻を01:10から16:10に変更
  - 詳細はこれらのツイートを参照のこと: https://twitter.com/ki_foobar/status/1105046955556724736?s=19
- スタックした井戸が同時に干上がっていたのを修正
- モイアーが死んでいてもセリフを話すのを修正
- ある隠し要素が動いていなかったのを修正
- シンプルな棚のアイテムチップのスタックする高さとY方向のオフセットを修正
- ESCを押しても詳細メニューから見た目変更メニューに戻れないのを修正
- グローバルマップで表示される「がある。」というメッセージを修正
- おみやげを渡したときの不自然な挙動を修正
  - NPCまたはペットに渡したとき、PCの重荷状態が更新されない
  - NPCに渡したとき、他のアイテムと異なりターンが経過しない
  - ペットに渡したとき、他のアイテムを連続して渡せない
  - ペットに渡したあと、直前のインベントリメニューを開く`x`を押すとそのペットに渡すメニューが表示される
- プレイヤーの視界の影の描写を修正。影のいくつかが繋がっていなかった
- 「二重マップ退出バグ」を修正
  - バグ: 依頼マップにおいて、ちょうど時間切れになるターンにマップから出ると、ワールドマップに出る
- いくつかのゲームイベントが「時間の逆転」を引き起こしうるのを修正
  - エヘカトルの中の神、結婚、ペットとの再会などのイベントは、本家では少々変わった方法で処理されていた。最も最近発生したイベントが最初に処理されていたが、これは最後になるべきであった
- 神託が予期しないアイテムを記録していることがあるのを修正
  - カードや剥製を願ったとき、そのキャラクタが持っている固定AFが神託に記録されていた。例えば、マニのカードを願うと猫の尻尾が信託に載っていた
- アリーナやペットアリーナで敵を倒さずに勝利することがあるのを修正
  - アリーナにおいて、5% ほどの確率でモンスターを倒していないのに勝利することがある。これはペットアリーナでも起こる
- 「達成のシーンをもう一度再現する？」というメッセージが表示される位置を修正



## 機能追加

- キャラメイク時に最低値ロール
- NPCの行動の数の上限を撤廃(10 -> 無制限)
- クイックセーブ&ロード
- Shiftキーを押しながらキャラクターと入れ替わる
- Wizardモードで常にHPバーを表示する
- Wizardモードで昇り階段/降り階段の位置をハイライト
- 自動採掘(autodig)
- 周りにドアが一つしかないとき閉じる方向を尋ねないように
- カスタム職業
- カスタム種族
- 設定ファイルにJSONを使用
- テキストの一部をLuaスクリプトに外部化
- データの一部をLuaスクリプトに外部化
- Luaを導入
- Autopickを試験的に実装
- ダメージポップアップを試験的に実装
- ペットのHPバーをomakeのように表示するように
- 紐で繋がれたペットのHPバーの横に紐のアイコンを表示するように
- 採掘モードを実装(oomEx互換)
- オートセーブを無効化するように
  - オプションメニューから再度有効にできます
- 入荷頻度をオプションから変更できるように
  - 0-10まで(日単位。デフォルト3日)。0を選ぶと話しかけるたびに品揃えが変わる
- ゲーム内からconfig.jsonのオプションの一部を変更できるように
  - Extra種族/職業
  - アニメウェイト/アラートウェイト
  - キーウェイト(初回)/キーウェイト
- `animewait`の設定に基づいてアニメーションの長さを削減
- いくつかのNPCに専用ポートレイトを設定
- 画面サイズ、フルスクリーンのオプションを追加
- カジノでエーテル抗体をもらえる確率を引き上げ
  - omakeと同じ
- 店売りの商品をスタックするように
- キャラメイクの際に最後の名前入力ボックスをキャンセルできるように
- キャラメイクの最終決定画面からポートレイトを選ぶ画面に戻れるように
- 選択した異名は異名ロール画面に戻って来たとき復元されるように
- omakeのような異名ロックを実装
  - `key_mode2`(デフォルトでは`*`)キーで異名をロックできる。ロックされた異名はリロールしても変わらない
- omakeのような数値入力を実装
- 分針を左上の時計に追加
- omake EN、omake overhaul EN、omake overhaul EN hackの翻訳を移植。これらを主に翻訳されたDoorknob氏に感謝申し上げます
- スキルトラック機能を拡張
  - 使えるスキルトラックの数を拡張(3->10)
  - スキルの潜在能力も一緒に表示
  - 高い潜在能力は緑で、低い潜在能力は赤で表示
- 原寸大PCC表示をサポート
- 設定メニューで各設定に説明を追加
- ダメージポップアップ機能を拡張
  - ポップアップの数を変更するオプションを追加
  - バフが追加された/消えたときポップアップを表示
  - 属性ダメージと回復に色をつけて表示
- 模様替え機能に塗りつぶしを実装
- セーブデータの読み込みを格段に高速化
- セーブデータの可搬性を向上。特にエンディアン
  - Elona foobarは常にデータをリトルエンディアンで保存します。ビッグエンディアンのマシンで動かした場合、foobarは読み込み時と保存時にデータを変換します
- ログウィンドウに分を`[05]`のようにして0を埋めた状態で表示
- 生もの装備を食べたときのメッセージの順番を変更
- 冒険者の名前をニュースに表示するように
- 矢弾を切り替えるメッセージの前で改行するように
- 周りにペットがいない状態で鏡台を使ったとき方向を尋ねないように
- ポートレイトシステムを改善。違う性別のポートレイトやNPC用のポートレイトを選べるようになった
- マナが足りない状態で詠唱しようとしたときの確認ウィンドウを省略するオプションを追加(デフォルト: オフ)
- テキストのアンチエイリアスを有効にするオプションを追加(default: オン)。また、アンチエイリアスが有効なときのテキスト描写をより美しいものとするため同梱するフォントを東風ゴシックから源真ゴシックへ変更
- 英語モードにおけるルードルボの名前を変更("yeek" → "<Rodlob> the boss of yeeks")
  - この名前は、日本語でそうであるように Angband のモンスターである "Boldor" のスペルを反転させたもの
- メッセージログをスクロールできるように(1000行分保持する)。利用可能なショートカットは以下の通り:
  - `Up`: 一行上へスクロール (古い方へ)
  - `Down`: 一行下へスクロール (新しい方へ)
  - `Left`: 一ページ上へスクロール (古い方へ)
  - `Right`: 一ページ下へスクロール (新しい方へ)
- 店で売買する際の確認プロンプトを省略できるオプションを追加(デフォルト: オフ)
- E+Cからメインシナリオの英語翻訳を移植
- ブラックジャックの描画を改善
  - キャラクタ画像を原寸大で表示するように
  - カードのスートを表示するように
  - カードのランクを画像として表示するように
- 現在のFPS(frame per second)を表示するオプションを追加(デフォルト: オフ)
- キーバインディングを実装。設定画面の一番下にあるキーバインディング画面から設定できる
- 大事な仲間が遺伝子合成で失われないように。聴診器を使うことで大事な仲間に指定できる
- `Shift+Backspace` でAutopickの定義ファイルを再読み込みできるように
- 新しいショートカットキー `Ctrl+Tab` を追加。一つ前の(左の)メニューへ移動する
- Autopick機能を強化。これらの新機能は概ねomake互換
  - カテゴリーベースのアイテム選択をサポート
  - アイテムの修飾語をサポート
- `log.txt`を削除し、`log`フォルダを追加。このフォルダは最大で10個直近のログファイルを保持する。`0.log`が最新で`9.log`が最古
- `music`オプションを文字列から真偽値に変更。`mci`と`direct_music`の間に特に違いがないため
- メインメニューの「ホームページを開く」を「About」に変更。このメニューは以下のサブメニューを含む
  - 本家ホームページ
  - Elona foobar ホームページ
  - Elona foobar 更新履歴
  - ライセンス
  - クレジット
- 家宝ランキングの表示される順番を入れ替え。1位が最初に、10位が最後に来る
-  「〜を維持する」と「〜を無効にする」のエンチャントをアイテムリストメニューに表示するように
  - 耐性の可視/不可視を切り替えるのと同様にして、`z`キーを押すことでモードを切り替えられる
  - なし → 耐性 → 維持と無効 → なし → ……
- プロファイルシステムの実装
  - `profile`フォルダを追加
  - プロファイルごとにセーブデータを分けられるようセーブフォルダを`profile/<プロファイル名>/save`に移動
  - プロファイルごとに設定を分けられるよう設定ファイルを`profile/<プロファイル名>/config.hcl`に移動
- NPCが潜在能力のポーションを飲んだとき自動保存しないように
- 乱数生成がある程度決定的になるように
- 乱数生成方法を線形合同法からxorshfitの亜種であるxoshiro256に変更
- Experimental: スクリーンショット機能を実装。`Print Screen`キー (キーは変更可能) からスクリーンショットを撮ることができる。スクリーンショットは`profile/[current profile]/screenshot`フォルダに保存される.
  - 今のところ、スクリーンショットはプレイヤーキャラクターが行動可能なときにしか撮ることができない
- foobarが内部で新しいファイルやフォルダを生成する際、システムによって予約されているパスをチェックするように
- 英語におけるアイテム名の複数形のルールを改善
- Experimental: マウスを部分的にサポート
- Experimental: パルミア・タイムズを実装。より細かいゲームプレイログ
- 本家のチャット/投票機能を実装
  - 送受信するものを決めるための関連するオプションを追加
- 見た目変更画面を改善。四方向を同時に表示するように
- 見た目変更画面における処理速度を改善。PCC画像を何か変更したときだけ読み込むように
- キーリピートを制御するための新しいオプションを追加
  - `initial_key_repeat_wait`: 最初の行動から二番目の行動までの待ちフレーム数
  - `key_repeat_wait`: 各行動間での待ちフレーム数
- ゲーム開始時に表示されるメッセージを変更
  - 元のメッセージ: "Lafrontier presents Elona ver 1.22. Welcome traveler!"
  - このヴァリアントは「Elona ver 1.22」でもなければ「Lafrontier」によって開発されているわけでもないため、メッセージを「Welcome traveler!」に変更
- クエスト関連のデータをクエスト依頼品のアイテムにセットしないように
  - この変更により、街の NPC が持つクエストアイテムが他のアイテムとスタックする
- bone ファイルの bone 数上限を撤廃 (以前は 80)
  - 以前の bone ファイル (`bone.txt`) と現在のものとは互換性がありません
- 「拡張設定(foobar)」にオートターゲットオプションを追加
  - 「する」に設定すると、仲間 (あなたを除く) が自動的にあなたから見えている敵を攻撃するようになる
  - 規定値: 「しない」
- 「拡張設定(foobar)」にデジタル時計にするオプションを追加
  - 「する」に設定すると、左上の時計が24時間のデジタル表示になる
  - 規定値: 「しない」
- 模様替えモードで部分的に元に戻す/やり直しをサポート
  - これは実験的機能であり、キーバインディングなどは将来のバージョンで変更されるかもしれません
- アプリケーションアイコン (atcat) を追加。今のところWindowsのみ
- コンソール機能を刷新
- コンソールコマンドを追加
 - `:wish`
 - `:gain_spell`
 - `:gain_exp`
 - `:gain_fame`
- SEとBGMの音量を調節するオプションを追加 (0-8まで)。デフォルトは 8 (最大音量)
- マップアイテムの内部表現を変更。これにより、一つのタイルにスタックさせられるアイテムの数が 3 から 4 に増えた。また、袋アイコンは「5種類以上のアイテムがスタックしている」ことを意味するようになり、袋2つだと10種類以上、袋3つだと15種類以上、袋4つだと20種類以上スタックしていることを意味するようになった
- セーブフォルダの名前の付け方を変更
 - 古いセーブデータの名前は変更されません。また、変更する必要もありません。
 - 副作用として、プレイヤー名の被りを気にせずに好きな名前をつけられるようになった
- 「盗む」のインベントリ画面を少しだけ変更
 - 地面のアイテムを盗むとき、本家や古い foobar ではプレイヤーの所持金が画面に表示される。これは無意味な情報であり、このバージョン以降では表示されないようになる
- セーブ選択画面に情報を追加
 - 古いセーブデータをこのバージョン以降でセーブすると、新しいファイル `header.json` が作られる。セーブデータがこのファイルを持っている場合、その情報がセーブ選択画面に表示される
- 荷車の荷物をショートカット登録できるように
 - ネフィアなどではこれまでどおり荷車の荷物を利用することはできません
- `i` 干渉 メニューに「吊る」選択肢を追加。任意の NPC を吊ることができる。Wizard モードでのみ利用可能

### UI
### 設定



## 削除

- 古いバージョン(1.16よりも前)との互換性を放棄
- F12のコンソールコマンドを削除
- 使用できないオプション(`cfg_msg_box`)を削除
- 本家のカスタムファイル形式への対応を削除
  - これは一時的な措置です。当然再度実装されます
- すでに必要なくなった`original/config.txt`はコピーしないように
- 古い本家のデータ(v1.22より前)へのサポートを削除
  - 将来的にはインポート・エクスポートができるようにする予定です
- `original`フォルダを削除。本家から`original`フォルダをコピーしてくる必要がなくなった
- `musiclist.txt`のサポートを削除。この機能はMODによっていずれ置き換えられる
- いくつかの設定を削除。これらはまったくあるいはほぼ効果がないか、めったに使われない
  - `ui.msg_line`
  - `ui.tile_size`
  - `ui.font_size`
  - `ui.inv_ver_type`
  - `ui.window_x`
  - `ui.window_y`
  - `ui.clock_x`
  - `ui.clock_w`
  - `ui.clock_h`
- ゲーム中で使われていないマップファイルを削除
- 未使用のセーブファイル`gdatan.s1`を削除
- `.map` ファイルの未使用部分を削除。ファイルサイズが平均して 90% 削減された
